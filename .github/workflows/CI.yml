name: CI Pipeline

on:
  push:
    branches: [ main ]

jobs:
  # --- Lint ---
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps (from requirements.txt)
        run: |
            pip install -r requirements.txt
      - name: Run linter
        run: flake8 .

  # --- Test (JUnit + coverage; всё берётся из requirements.txt) ---
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps (from requirements.txt)
        run: |
          pip install -r requirements.txt
      - name: Run tests with JUnit + coverage
        run: |
          # pytest/pytest-cov должны быть в requirements.txt
          pytest --cov-report=xml:coverage.xml --cov-report=html -q
      - name: Upload JUnit report
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: report.xml
      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  # --- Build (после тестов). Если у тебя нет Docker-сборки в CI — оставляем как заглушку/проверку ---
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Build step
        run: |
          echo "Build successful for spotify_bot"
          # Если захочешь собирать docker-образ в CI — раскомментируй:
          # docker build -t spotify_bot:ci .
          # (и при желании запушить в Registry)

  # --- Deploy (в одном файле с CI) + smoke-check на сервере ---
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to Debian VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            cd ~/spotify_bot
            ./deploy.sh

            # --- SMOKE: проверяем контейнер и логи ---
            cname="spotify_bot"   # поправь, если имя другое
            # ждём маркер "Бот запущен" в логах (замени на свой фактический маркер)
            timeout 25s bash -c 'until docker logs '"$cname"' 2>&1 | grep -q "Бот запущен"; do sleep 1; done'
            # убеждаемся, что контейнер реально Up
            docker ps --format '{{.Names}}' | grep -q "^${cname}$"
  e2e:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Run smoke test
        run: bash tests/e2e/smoke.sh
